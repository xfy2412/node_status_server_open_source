<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>服务器状态监控</title>
  <!-- Chart.js 库 -->
  <link rel="icon" type="image/png" href="https://xfyweb.cn/background.jpg" />
  <link rel="apple-touch-icon" href="https://xfyweb.cn/background.jpg" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }
    
    .time-bar {
      background-color: #2c3e50;
      color: #fff;
      padding: 10px 20px;
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
    }
    
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .status-card {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    
    .status-card h3 {
      font-size: 18px;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    
    .status-badge {
      padding: 5px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }
    
    .status-ok {
      background-color: #d4edda;
      color: #155724;
    }
    
    .status-off {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .status-unknown {
      background-color: #fff3cd;
      color: #856404;
    }
    
    .system-stats {
      margin-top: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stat-card {
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 16px;
      color: #6c757d;
      margin-bottom: 10px;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .memory-bar {
      width: 100%;
      height: 8px;
      background-color: #e9ecef;
      border-radius: 4px;
      margin-top: 10px;
      overflow: hidden;
    }
    
    .memory-fill {
      height: 100%;
      background-color: #007bff;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .charts-section {
      margin-top: 30px;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin-bottom: 30px;
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
    }
    
    .ip-stats {
      margin-top: 30px;
    }
    
    .ip-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .ip-table th,
    .ip-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e9ecef;
    }
    
    .ip-table th {
      background-color: #e9ecef;
      font-weight: bold;
    }
    
    .ip-table tr:last-child td {
      border-bottom: none;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #6c757d;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        padding: 15px;
      }
      
      .status-card {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .status-badge {
        margin-top: 10px;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .chart-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <div class="time-bar" id="time-bar">加载中...</div>
  
  <div class="container">
    <h1>服务器状态监控</h1>
    
    <div class="system-stats">
      <h2>系统资源</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>内存使用</h3>
          <div class="stat-value" id="memory-usage">加载中...</div>
          <div class="memory-bar">
            <div id="memory-fill" class="memory-fill" style="width: 0%"></div>
          </div>
          <div style="margin-top: 5px; font-size: 12px; color: #6c757d;">
            <span id="memory-details">加载中...</span>
          </div>
        </div>
        
        <div class="stat-card">
          <h3>CPU信息</h3>
          <div class="stat-value" id="cpu-model">加载中...</div>
          <div style="margin-top: 5px; font-size: 12px; color: #6c757d;">
            <span id="cpu-count">加载中...</span>
          </div>
        </div>
        
        <div class="stat-card">
          <h3>系统运行时间</h3>
          <div class="stat-value" id="uptime">加载中...</div>
        </div>
        
        <div class="stat-card">
          <h3>系统信息</h3>
          <div class="stat-value" id="hostname">加载中...</div>
          <div style="margin-top: 5px; font-size: 12px; color: #6c757d;">
            <span id="system-info">加载中...</span>
          </div>
        </div>
      </div>
    </div>
    
    <div class="charts-section">
      <h2>10分钟资源占用</h2>
      <div class="chart-container">
        <canvas id="memory-chart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="cpu-chart"></canvas>
      </div>
    </div>
    
    <div class="ip-stats">
      <h2>请求数量前5的IP地址</h2>
      <table class="ip-table">
        <thead>
          <tr>
            <th>排名</th>
            <th>IP地址</th>
            <th>请求数量</th>
          </tr>
        </thead>
        <tbody id="ip-table-body">
          <tr>
            <td colspan="3" style="text-align: center;">加载中...</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="footer">
      <p>最后更新: <span id="last-updated">加载中...</span></p>
      <p>自动刷新: <span id="refresh-status">15秒</span></p>
    </div>
  </div>
  
  <script>
    // 图表实例
    let memoryChart, cpuChart;
    
    // 初始化图表
    function initCharts() {
      // 内存图表
      const memoryCtx = document.getElementById('memory-chart').getContext('2d');
      memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: '内存使用率 (%)',
            data: [],
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: '使用率 (%)'
              }
            },
            x: {
              title: {
                display: true,
                text: '时间'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: '10分钟内存使用趋势'
            },
            legend: {
              display: false
            }
          }
        }
      });
      
      // CPU图表
      const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
      cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'CPU使用率 (%)',
            data: [],
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderWidth: 2,
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: '使用率 (%)'
              }
            },
            x: {
              title: {
                display: true,
                text: '时间'
              }
            }
          },
          plugins: {
            title: {
              display: true,
              text: '10分钟CPU使用趋势'
            },
            legend: {
              display: false
            }
          }
        }
      });
    }
    
    // 获取状态信息
    async function getStatus() {
      try {
        const response = await fetch('/api/status');
        
        if (!response.ok) {
          if (response.status === 429) {
            console.error('请求过于频繁');
            // 显示请求过于频繁的提示
            document.getElementById('refresh-status').textContent = '请求过于频繁，请稍后再试';
            document.getElementById('refresh-status').style.color = 'red';
          }
          return;
        }
        
        const data = await response.json();
        
        if (data.success) {
          // 更新系统信息
          updateSystemStats(data.system);
          // 更新IP请求统计
          updateIPStats(data.topIPs);
          // 更新图表
          updateCharts(data.system.history);
          // 更新时间
          document.getElementById('last-updated').textContent = new Date().toLocaleString();
          // 重置刷新状态
          document.getElementById('refresh-status').textContent = '15秒';
          document.getElementById('refresh-status').style.color = '';
        }
      } catch (error) {
        console.error('获取状态失败:', error);
      }
    }
    
    // 更新系统信息
    function updateSystemStats(system) {
      // 内存信息
      document.getElementById('memory-usage').textContent = system.memory.usage;
      document.getElementById('memory-details').textContent = system.memory.used + ' / ' + system.memory.total;
      
      // 解析内存使用百分比
      const memoryUsage = parseFloat(system.memory.usage);
      document.getElementById('memory-fill').style.width = memoryUsage + '%';
      
      // CPU信息
      document.getElementById('cpu-model').textContent = system.cpu.model;
      document.getElementById('cpu-count').textContent = system.cpu.count + ' 核心';
      
      // 运行时间
      document.getElementById('uptime').textContent = system.system.uptime;
      
      // 系统信息
      document.getElementById('hostname').textContent = system.system.hostname;
      document.getElementById('system-info').textContent = system.system.platform + ' ' + system.system.arch;
    }
    
    // 更新IP请求统计
    function updateIPStats(topIPs) {
      const tableBody = document.getElementById('ip-table-body');
      tableBody.innerHTML = '';
      
      if (topIPs && topIPs.length > 0) {
        topIPs.forEach((item, index) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.ip}</td>
            <td>${item.count}</td>
          `;
          tableBody.appendChild(row);
        });
      } else {
        const row = document.createElement('tr');
        row.innerHTML = '<td colspan="3" style="text-align: center;">暂无数据</td>';
        tableBody.appendChild(row);
      }
    }
    
    // 更新图表
    function updateCharts(history) {
      if (!history || !history.timestamp || !memoryChart || !cpuChart) return;
      
      // 格式化时间标签
      const labels = history.timestamp.map(timestamp => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString();
      });
      
      // 更新内存图表
      memoryChart.data.labels = labels;
      memoryChart.data.datasets[0].data = history.memory;
      memoryChart.update();
      
      // 更新CPU图表
      cpuChart.data.labels = labels;
      cpuChart.data.datasets[0].data = history.cpu;
      cpuChart.update();
    }
    
    // 初始化图表
    initCharts();
    
    // 初始获取状态
    getStatus();
    
    // 更新时间栏
    function updateTimeBar() {
      const now = new Date();
      const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        weekday: 'long',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
      };
      
      const timeString = now.toLocaleString('zh-CN', options);
      document.getElementById('time-bar').textContent = timeString;
    }
    
    // 初始更新时间栏
    updateTimeBar();
    
    // 定时更新时间栏
    setInterval(updateTimeBar, 1000);
    
    // 定时刷新
    setInterval(getStatus, 15000);
  </script>
</body>
</html>